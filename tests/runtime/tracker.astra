module tests.runtime.tracker

import examples.project.tracker.{make_task, complete_task, format_task, find_task, mark_done, pending_tasks, done_count, priority_label, Low, Critical}

test "make_task rejects empty title" {
  let result = make_task(1, "", "high")
  match result {
    Ok(_) => assert(false)
    Err(msg) => assert(msg.contains("empty"))
  }
}

test "make_task creates valid task" {
  let result = make_task(1, "Write docs", "high")
  match result {
    Ok(task) => {
      assert_eq(task.id, 1)
      assert_eq(task.title, "Write docs")
      assert_eq(task.done, false)
    }
    Err(_) => assert(false)
  }
}

test "complete_task marks done" {
  let task = { id = 1, title = "Test", priority = "low", done = false }
  let completed = complete_task(task)
  assert_eq(completed.done, true)
  assert_eq(completed.id, 1)
}

test "find_task returns matching task" {
  let tasks = [
    { id = 1, title = "A", priority = "low", done = false },
    { id = 2, title = "B", priority = "high", done = false },
  ]
  let found = find_task(tasks, 2)
  match found {
    Some(t) => assert_eq(t.title, "B")
    None => assert(false)
  }
}

test "find_task returns None for missing id" {
  let tasks = [
    { id = 1, title = "A", priority = "low", done = false },
  ]
  let found = find_task(tasks, 99)
  match found {
    Some(_) => assert(false)
    None => assert(true)
  }
}

test "mark_done updates task" {
  let tasks = [
    { id = 1, title = "Do something", priority = "high", done = false },
  ]
  let result = mark_done(tasks, 1)
  match result {
    Ok(updated) => {
      let t = find_task(updated, 1)
      match t {
        Some(task) => assert_eq(task.done, true)
        None => assert(false)
      }
    }
    Err(_) => assert(false)
  }
}

test "pending_tasks filters correctly" {
  let tasks = [
    { id = 1, title = "A", priority = "low", done = true },
    { id = 2, title = "B", priority = "high", done = false },
    { id = 3, title = "C", priority = "medium", done = false },
  ]
  let pending = pending_tasks(tasks)
  assert_eq(pending.len(), 2)
}

test "done_count works" {
  let tasks = [
    { id = 1, title = "A", priority = "low", done = true },
    { id = 2, title = "B", priority = "high", done = true },
    { id = 3, title = "C", priority = "medium", done = false },
  ]
  assert_eq(done_count(tasks), 2)
}

test "format_task shows correct format" {
  let task = { id = 1, title = "Test task", priority = "high", done = false }
  let formatted = format_task(task)
  assert(formatted.contains("#1"))
  assert(formatted.contains("[high]"))
  assert(formatted.contains("Test task"))
}

test "priority_label returns correct labels" {
  assert_eq(priority_label(Low), "low")
  assert_eq(priority_label(Critical), "CRITICAL")
}
